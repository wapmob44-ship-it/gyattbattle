<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alon Gyatt Index</title>
<!-- CRT Effect (delete these 2 lines to remove CRT effect) -->
<link rel="stylesheet" href="crt-effect.css">
<script src="crt-effect.js"></script>
<!-- Boss Battle System -->
<link rel="stylesheet" href="boss/boss-styles.css">
<script src="boss/boss-system.js"></script>
<style>
/* --- your CSS unchanged --- */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    background-image: url('bg3.png');
    background-size: cover;
    background-position: center 100%;
    background-repeat: no-repeat;
    height: 100vh;
    width: 100vw;
    overflow: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    transition: background-position 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55), filter 0.2s ease;
    filter: blur(0px);
}

.container { position: relative; width: 100%; height: 100%; }
.marketcap-info {
    position: absolute;
    top: 30px;
    right: 20px;
    background: #000;
    color: #fff;
    padding: 15px 25px;
    border: 3px solid #fff;
    border-radius: 0;
    font-size: 36px;
    z-index: 1000;
    font-family: 'Courier New', monospace;
}
.marketcap-amount {
    color: #00ff40;
    transition: color 0.5s ease, text-shadow 0.5s ease;
}
.marketcap-amount.animating {
    text-shadow: 0 0 10px #00ff40, 0 0 20px #00ff40, 0 0 30px #00ff40;
}
.marketcap-amount.animating.decreasing {
    color: #ff4444;
    text-shadow: 0 0 10px #ff4444, 0 0 20px #ff4444, 0 0 30px #ff4444;
}
.instruction-text {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    color: #00ff40;
    font-family: 'Courier New', monospace;
    font-size: 18px;
    text-align: center;
    z-index: 1000;
}
.sound-toggle {
    position: absolute;
    top: 130px;
    right: 20px;
    background: #000;
    color: #00ff40;
    border: 3px solid #fff;
    border-radius: 0;
    padding: 12px 16px;
    font-size: 16px;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.2s ease;
    font-family: 'Courier New', monospace;
}
.sound-toggle:hover {
    background-color: rgba(0, 255, 64, 0.1);
    border-color: #00ff40;
}
.sound-toggle.disabled {
    color: #666;
    border-color: #666;
}
.now-playing {
    background: #000;
    color: #00ff40;
    border: 3px solid #fff;
    border-radius: 0;
    padding: 12px 16px;
    font-size: 16px;
    font-family: 'Courier New', monospace;
}
.social-buttons {
    position: absolute;
    bottom: 80px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1000;
}
.social-btn {
    background: #000;
    color: #00ff40;
    border: 3px solid #fff;
    border-radius: 0;
    padding: 12px 16px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Courier New', monospace;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}
.social-btn:hover {
    background-color: rgba(0, 255, 64, 0.1);
    border-color: #00ff40;
    color: #00ff40;
}
.sound-wave {
    display: inline-block;
    margin-right: 8px;
}
.sound-wave span {
    display: inline-block;
    width: 2px;
    height: 8px;
    background: #00ff40;
    margin-right: 1px;
    animation: wave 1.2s ease-in-out infinite;
}
.sound-wave span:nth-child(2) { animation-delay: 0.1s; }
.sound-wave span:nth-child(3) { animation-delay: 0.2s; }
.sound-wave span:nth-child(4) { animation-delay: 0.3s; }
.sound-wave span:nth-child(5) { animation-delay: 0.4s; }
@keyframes wave {
    0%, 100% { height: 4px; }
    50% { height: 12px; }
}
.track-controls {
    position: absolute;
    top: 200px;
    right: 20px;
    display: flex;
    align-items: center;
    gap: 5px;
    z-index: 1000;
}
.skip-btn {
    height: 47px;
    background: #000;
    color: #00ff40;
    border: 2px solid #fff;
    border-radius: 0;
    padding: 8px 10px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Courier New', monospace;
    line-height: 1;
}
.skip-btn:hover {
    background-color: rgba(0, 255, 64, 0.1);
    border-color: #00ff40;
}
.dialogue-box {
    position: fixed;
    top: 40px;
    left: 50%;
    transform: translateX(-50%);
    width: 700px;
    height: 180px;
    background: #000;
    border: 3px solid #fff;
    border-radius: 0;
    z-index: 15000;
    display: none;
    font-family: 'Courier New', monospace;
    animation: dialogueAppear 0.3s ease-out;
}
.dialogue-portrait {
    position: absolute;
    left: 10px;
    top: 10px;
    width: 80px;
    height: 80px;
    background: #333;
    border: 2px solid #fff;
}
.dialogue-portrait img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.dialogue-content {
    position: absolute;
    left: 110px;
    top: 10px;
    right: 10px;
    bottom: 10px;
}
.dialogue-name {
    color: #fff;
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 5px;
}
.dialogue-text {
    color: #fff;
    font-size: 28px;
    line-height: 1.4;
    word-wrap: break-word;
}
@keyframes dialogueAppear {
    0% {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    100% {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}
.image-stack {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
    transition: transform 0.2s cubic-bezier(0.68,-0.55,0.265,1.55);
}
.top-image {
    max-width: 64%;
    max-height: 40%;
    margin-bottom: -20px;
    transform: translate(44px, 23px);
    z-index: 10000;
    transition: transform 0.2s cubic-bezier(0.68,-0.55,0.265,1.55);
}
.bottom-image {
    max-width: 48%;
    max-height: 20%;
    z-index: 10001;
    transform-origin: center bottom;
    transition: transform 0.2s cubic-bezier(0.68,-0.55,0.265,1.55);
}
.ruler-container { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    pointer-events: none; 
    z-index: 0; 
}
.ruler { 
    position: relative; 
    width: 100%; 
    height: 100%; 
}
.ruler-line { 
    position: absolute; 
    left: 50%; 
    top: 0; 
    width: 2px; 
    height: 100%; 
    background: rgba(255,255,255,0.3); 
    transform: translateX(-50%);
}
.tick { 
    position: absolute; 
    left: 0; 
    width: 100%; 
    height: 2px; 
    background: white; 
}
.tick-label { 
    position: absolute; 
    left: 20px; 
    color: white; 
    font-size: 44px; 
    transform: translateY(-50%) translateY(-28px); 
    white-space: nowrap;
    font-family: 'Courier New', monospace;
}
.ruler-pointer { 
    position: absolute; 
    left: -1px; 
    width: 4px; 
    height: 4px; 
    background: rgb(0, 255, 85); 
    border-radius: 50%;
}
.confetti {
    position: fixed;
    width: 200px;
    height: 120px;
    pointer-events: none;
    z-index: 5000;
    animation: confetti-fall 2s ease-out forwards;
}
.confetti-text {
    position: fixed;
    pointer-events: none;
    z-index: 5000;
    animation: confetti-fall 2s ease-out forwards;
    color: white;
    font-size: 24px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    white-space: nowrap;
}
.carousel-container {
    position: fixed;
    bottom: 10px;
    left: 0;
    width: 100%;
    height: 40px;
    overflow: hidden;
    z-index: 200;
    background: rgba(0,0,0,0.3);
}
.carousel-text {
    position: absolute;
    white-space: nowrap;
    color: #00ff40;
    font-size: 36px;
    font-weight: normal;
    line-height: 40px;
    right: 0;
    animation: scroll-right-to-left 10s linear infinite;
    font-family: 'Courier New', monospace;
}
@keyframes scroll-right-to-left {
    0% {
        transform: translateX(100%);
    }
    100% {
        transform: translateX(-100vw);
    }
}
.arrow-up {
    position: fixed;
    width: 60px;
    height: 150px;
    pointer-events: none;
    z-index: 5000;
    animation: shoot-up 3s ease-out forwards;
    filter: brightness(1.5) saturate(2) drop-shadow(0 0 15px #00ff40);
}
@keyframes shoot-up {
    0% {
        transform: translateY(100vh) rotate(0deg) scale(var(--arrow-scale, 1));
        opacity: 1;
    }
    90% {
        transform: translateY(-80vh) rotate(var(--arrow-rotation, 0deg)) scale(var(--arrow-scale, 1));
        opacity: 1;
    }
    100% {
        transform: translateY(-100vh) rotate(var(--arrow-rotation, 0deg)) scale(var(--arrow-scale, 1));
        opacity: 0;
    }
}
@keyframes confetti-fall {
    0% {
        transform: translateY(-100vh) rotate(0deg) scale(var(--random-scale, 1));
        opacity: 1;
    }
    100% {
        transform: translateY(100vh) rotate(var(--random-rotation, 45deg)) scale(var(--random-scale, 1));
        opacity: 0;
    }
}
.bounce-animation { animation: bounceScale 1.2s cubic-bezier(0.68,-0.55,0.265,1.55); }
@keyframes bounceScale {
    0% { transform: scale(var(--current-scale)); }
    50% { transform: scale(calc(var(--current-scale) + 0.1)); }
    100% { transform: scale(var(--new-scale)); }
}

.growth-rate-meter {
    position: fixed;
    bottom: 120px;
    left: 20px;
    width: 250px;
    background: #000;
    border: 2px solid #fff;
    padding: 15px;
    font-family: 'Courier New', monospace;
    z-index: 1000;
}

.meter-label {
    color: #fff;
    font-size: 14px;
    margin-bottom: 8px;
    text-align: center;
}

.meter-container {
    position: relative;
    width: 100%;
    height: 25px;
    background: #333;
    border: 1px solid #fff;
}

.meter-fill {
    height: 100%;
    background: linear-gradient(90deg, #00ff40 0%, #ffff00 50%, #ff4444 100%);
    width: 0%;
    transition: width 0.5s ease;
}

.meter-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #fff;
    font-size: 12px;
    text-shadow: 1px 1px 2px #000;
}

.achievement-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    width: 400px;
    background: #000;
    border: 3px solid #ffd700;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    z-index: 20000;
    font-family: 'Courier New', monospace;
    box-shadow: 0 0 30px #ffd700;
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.achievement-popup.show {
    transform: translate(-50%, -50%) scale(1);
}

.achievement-icon {
    font-size: 60px;
    margin-bottom: 10px;
}

.achievement-title {
    color: #ffd700;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 10px;
}

.achievement-description {
    color: #fff;
    font-size: 16px;
}

.achievement-counter {
    position: fixed;
    bottom: 60px;
    left: 20px;
    background: #000;
    border: 2px solid #ffd700;
    padding: 10px 15px;
    font-family: 'Courier New', monospace;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 1000;
}

.counter-icon {
    font-size: 20px;
}

.counter-text {
    color: #ffd700;
    font-size: 16px;
    font-weight: bold;
}

@keyframes fireworkExplode {
    0% {
        transform: scale(0);
        opacity: 1;
    }
    50% {
        transform: scale(3);
        opacity: 0.8;
    }
    100% {
        transform: scale(6);
        opacity: 0;
    }
}
</style>
</head>
<body>

<audio id="audioUp" src="audio1.mp3" preload="auto"></audio>
<audio id="audioDown" src="audio2.mp3" preload="auto"></audio>
<audio id="cheerSound" src="cheer.mp3" preload="auto"></audio>
<audio id="coinSound" src="coin.mp3" preload="auto"></audio>
<audio id="fireworksSound" src="fireworks.mp3" preload="auto"></audio>
<audio id="bgMusic1" src="bgmusic.mp3" preload="auto"></audio>
<audio id="bgMusic2" src="bgmusic2.mp3" preload="auto"></audio>
<audio id="bgMusic3" src="bgmusic3.mp3" preload="auto"></audio>
<audio id="bgMusic4" src="bgmusic4.mp3" preload="auto"></audio>
<audio id="bgMusic5" src="bgmusic5.mp3" preload="auto"></audio>
<audio id="bgMusic6" src="bgmusic6.mp3" preload="auto"></audio>
<audio id="bgMusic7" src="bgmusic7.mp3" preload="auto"></audio>
<audio id="bgMusic8" src="bgmusic8.mp3" preload="auto"></audio>
<audio id="bgMusic9" src="bgmusic9.mp3" preload="auto"></audio>
<audio id="bgMusic10" src="bgmusic10.mp3" preload="auto"></audio>
<audio id="bgMusic11" src="bgmusic11.mp3" preload="auto"></audio>
<audio id="bgMusic12" src="bgmusic12.mp3" preload="auto"></audio>
<audio id="bgMusic13" src="bgmusic13.mp3" preload="auto"></audio>

<div class="instruction-text">every $AGI buy makes Alons GYATT grow, every sell shrinks it</div>

<div class="container">
    <div class="marketcap-info" id="marketCap">Market Cap: <span class="marketcap-amount">Loading...</span></div>
    <div class="growth-rate-meter" id="growthRateMeter">
        <div class="meter-label">GYATT GROWTH RATE</div>
        <div class="meter-container">
            <div class="meter-fill" id="meterFill"></div>
            <div class="meter-text" id="meterText">0%/min</div>
        </div>
    </div>
    <div class="achievement-counter" id="achievementCounter">
        <div class="counter-icon">🏆</div>
        <div class="counter-text" id="counterText">0/15</div>
    </div>
    <button class="sound-toggle" id="soundToggle">🔊 Special effects ON</button>
    <div class="social-buttons">
        <a href="https://x.com/AlonGyattIndex" target="_blank" class="social-btn">X</a>
        <a href="https://pump.fun/coin/4E5gVEbkZTwGBbipC1AEqiXkFZSarckthAi5EbPepump" target="_blank" class="social-btn">Pump.fun</a>
    </div>
    <div class="track-controls" id="trackControls" style="display: none;">
        <button class="skip-btn" id="prevTrack">‹</button>
        <div class="now-playing" id="nowPlaying">
            <div class="sound-wave">
                <span></span><span></span><span></span><span></span><span></span>
            </div>
            <span id="trackName">Track 1</span>
        </div>
        <button class="skip-btn" id="nextTrack">›</button>
    </div>

    <div class="image-stack" id="imageStack">
        <img src="top.png" alt="Top Image" class="top-image" id="topImage">
        <img src="bottom.png" alt="Bottom Image" class="bottom-image" id="bottomImage">
    </div>

    <!-- Ruler -->
    <div class="ruler-container">
        <div class="ruler" id="ruler">
            <div class="ruler-line"></div>
            <div class="ruler-pointer" id="rulerPointer"></div>
        </div>
    </div>

</div>

<!-- Carousel -->
<div class="carousel-container" id="carouselContainer">
</div>

<!-- Dialogue Box -->
<div class="dialogue-box" id="dialogueBox">
    <div class="dialogue-portrait">
        <img src="top.png" alt="Alon">
    </div>
    <div class="dialogue-content">
        <div class="dialogue-name">Alon</div>
        <div class="dialogue-text" id="dialogueText">wow you guys are making my gyatt grow so large</div>
    </div>
</div>

<!-- Achievement Popup -->
<div class="achievement-popup" id="achievementPopup">
    <div class="achievement-icon">🏆</div>
    <div class="achievement-title" id="achievementTitle">Achievement Unlocked!</div>
    <div class="achievement-description" id="achievementDesc">Description here</div>
</div>

<script>
let scaleFactor = 1;
let backgroundPosition = 100;

const bottomImage = document.getElementById('bottomImage');
const topImage = document.getElementById('topImage');
const imageStack = document.getElementById('imageStack');
const marketCapDisplay = document.getElementById('marketCap');
const ruler = document.getElementById('ruler');
const rulerPointer = document.getElementById('rulerPointer');
const audioUp = document.getElementById('audioUp');
const audioDown = document.getElementById('audioDown');
const cheerSound = document.getElementById('cheerSound');
const coinSound = document.getElementById('coinSound');
const fireworksSound = document.getElementById('fireworksSound');
const bgMusicTracks = [
    document.getElementById('bgMusic1'),
    document.getElementById('bgMusic2'),
    document.getElementById('bgMusic3'),
    document.getElementById('bgMusic4'),
    document.getElementById('bgMusic5'),
    document.getElementById('bgMusic6'),
    document.getElementById('bgMusic7'),
    document.getElementById('bgMusic8'),
    document.getElementById('bgMusic9'),
    document.getElementById('bgMusic10'),
    document.getElementById('bgMusic11'),
    document.getElementById('bgMusic12'),
    document.getElementById('bgMusic13')
];
let currentTrackIndex = 0;
let currentBgMusic = bgMusicTracks[0];

const minMc = 5000, maxMc = 200000;
const supply = 1_000_000_000;
let lastMc = minMc;

// Growth rate tracking
let growthRateHistory = [];
let currentGrowthRate = 0;

// Achievement system
let achievements = {
    firstPump: { unlocked: false, title: "First Pump!", desc: "Market cap increased for the first time", threshold: 0 },
    baby: { unlocked: false, title: "Baby Gyatt", desc: "Reached 10k market cap", threshold: 10000 },
    growing: { unlocked: false, title: "Inch By Inch", desc: "Reached 25k market cap", threshold: 25000 },
    milestone41: { unlocked: false, title: "WE GYATT TO GO HIGHER", desc: "Reached 41k market cap", threshold: 41000 },
    halfway: { unlocked: false, title: "Halfway There", desc: "Reached 50k market cap", threshold: 50000 },
    bigBoy: { unlocked: false, title: "Big Boy Gyatt", desc: "Reached 75k market cap", threshold: 75000 },
    sixFigures: { unlocked: false, title: "Six Figures!", desc: "Reached 100k market cap", threshold: 100000 },
    massive: { unlocked: false, title: "Massive Gyatt", desc: "Reached 150k market cap", threshold: 150000 },
    legendary: { unlocked: false, title: "Space Gyatt", desc: "Reached 200k market cap", threshold: 200000 },
    whale: { unlocked: false, title: "Whale Alert", desc: "Single pump over 10k", threshold: 0 },
    diamond: { unlocked: false, title: "Diamond Gyatt", desc: "Reached 500k market cap", threshold: 500000 },
    moon: { unlocked: false, title: "To The Moon!", desc: "Reached 1M market cap", threshold: 1000000 },
    streak3: { unlocked: false, title: "Hot Streak", desc: "3 market cap increases in a row", threshold: 0 },
    streak5: { unlocked: false, title: "On Fire!", desc: "5 market cap increases in a row", threshold: 0 },
    streak10: { unlocked: false, title: "Unstoppable Force", desc: "10 market cap increases in a row", threshold: 0 }
};

let achievementCount = 0;
let milestonesFired = new Set();
let consecutiveIncreases = 0;
let isFirstLoad = true;

// Carousel messages
const carouselMessages = [
    "pls pamp alons gyatt by using the new $AGI facilitated technology on pumpfun",
    "new $AGI technology facilitated on pumpfun allows you to increase its founders gyatt size",
    "every buy pamps the gyatt facilitated by groundbraking $AGI technology on pumpfun",
    "help alon reach the moon powered by the latest $AGI technology on pumpfun",
    "help theyre holding me hostage and forcing me to develop $AGI gyatt technology"
];
const jeetMessage = "the jeets are attacking alons gyatt size, concerned that the advanced technology may threaten their sidelined positions";
let currentMessageIndex = 0;
let isJeetMode = false;

const dialogueMessages = [
    "wow you guys are making my gyatt grow so large",
    "i dont know how to explain my gyatt size to my ct following",
    "delete this right now",
    "its just getting started",
    "someone stop this madness",
    "fuck it. jew mode.",
    "holy shit im going to need a bigger chair",
    "i regret making pumpfun streams a thing",
    "probably higher",
    "pumpfolio looking good here",
    "creator capital markets my ass",
    "my ass so fat i have to pay property taxes",
    "looks like you will need a bigger monitor",
    "ground breaking technology they said, kinda true lol",
    "dexscreener competitor?",
    "woah what a BUNDA",
    "yooooo its growing",
    "This is what satoshi dreamed for",
    "future of finance right here",
    "ngl fullporting",
    "make sure to follow the X",
    "who tf made this",
    "someone really spent hours making this",
    "next level memecoin",
    "my gyatt is literally blocking my cell service",
    "this is what peak performance looks like",
    "my chair cant handle this much gyatt",
    "probably nothing",
    "sir this is a wendys",
    "wen lambo? wen bigger pants?",
    "i need to call my insurance company",
    "this gyatt is going parabolic",
    "diamond hands on this gyatt growth",
    "my streams are never going to be the same",
    "i cant even fit through doorways anymore",
    "my gyatt has its own gravitational pull",
    "NASA wants to study my ass expansion",
    "breaking: local man's gyatt causes market disruption",
    "my gyatt just got verified on twitter",
    "this is bigger than the internet bubble",
    "my pants manufacturer just went public",
    "i need to hire a structural engineer for my chair",
    "my gyatt is trending on google",
    "someone call the guinness book of world records",
    "my ass is now classified as real estate",
    "i just got a tax bill for my gyatt size",
    "this gyatt growth is unsustainable",
    "my insurance premiums just tripled",
    "i need a permit for this level of gyatt",
    "my gyatt is causing traffic delays",
    "seismic activity detected in my area",
    "my gyatt just broke the sound barrier",
    "the SEC cant regulate this level of gyatt",
    "bullish on gyatt technology",
    "to the moon and beyond my ass",
    "this is financial advice: buy a bigger screen",
    "my gyatt market cap higher than most altcoins",
    "vitalik could never",
    "web3 was leading to this moment",
    "the flippening but its my ass cheeks",
    "number go up, gyatt go bigger",
    "this is not what i meant by mass adoption",
    "my gyatt has its own gravitational pull now",
    "houston we have a problem",
    "breaking: local mans gyatt disrupts global markets",
    "i should have read the smart contract",
    "this is why we cant have nice things",
    "my gyatt is now a registered security",
    "probably the most expensive ass in crypto",
    "wagmi? more like waggyatt",
    "this gyatt is deflationary",
    "my ass is literally too big to fail",
    "ngmi if you dont buy bigger pants",
    "this is peak degen behavior",
    "my gyatt just hit a new ATH",
    "inch by inch",
    "im gonna need a structural engineer for this gyatt",
    "my gyatt is now visible from space",
    "breaking news: local gyatt causes seismic activity",
    "the fed is considering raising rates because of my ass",
    "my gyatt just got its own zip code",
    "someone call nasa, we have liftoff",
    "this gyatt is single handedly inflating the economy",
    "my chair manufacturer just went public",
    "architects are studying my gyatt for inspiration",
    "my gyatt has achieved escape velocity",
    "the IMF wants to classify my ass as a currency",
    "my gyatt is now a UNESCO world heritage site",
    "scientists are using my gyatt to study gravity",
    "my ass just broke the sound barrier",
    "the UN wants to put sanctions on my gyatt size",
    "my gyatt is causing tidal waves in the pacific",
    "DYNAMIC_MARKETCAP_COMPLAINT",
    
];
let dialogueTimeout = null;
let typeTextTimeout = null;

function typeText(element, text, speed = 50) {
    // Clear any existing typing animation
    if (typeTextTimeout) {
        clearTimeout(typeTextTimeout);
    }
    
    element.textContent = '';
    let i = 0;
    
    function typeChar() {
        if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            typeTextTimeout = setTimeout(typeChar, speed);
        } else {
            typeTextTimeout = null;
        }
    }
    
    typeChar();
}

function showDialogue() {
    // Don't show dialogue during boss battles
    if (window.bossSystemPaused) {
        return;
    }
    
    const dialogueBox = document.getElementById('dialogueBox');
    const dialogueText = document.getElementById('dialogueText');
    
    let randomMessage = dialogueMessages[Math.floor(Math.random() * dialogueMessages.length)];
    
    // Handle dynamic market cap complaint
    if (randomMessage === "DYNAMIC_MARKETCAP_COMPLAINT" && lastMc) {
        randomMessage = `only $${lastMc.toLocaleString()} really? this gyatt deserves more`;
    }
    
    dialogueBox.style.display = 'block';
    
    // Start typing animation
    typeText(dialogueText, randomMessage, 60);
    
    // Calculate time needed for typing + 2 seconds buffer
    const typingTime = randomMessage.length * 60; // 60ms per character
    const hideDelay = Math.max(typingTime + 2000, 5000); // At least 5 seconds total
    
    // Clear any existing hide timeout
    if (window.dialogueHideTimeout) {
        clearTimeout(window.dialogueHideTimeout);
    }
    
    // Hide dialogue after typing is complete + buffer
    window.dialogueHideTimeout = setTimeout(() => {
        dialogueBox.style.display = 'none';
        window.dialogueHideTimeout = null;
    }, hideDelay);
}

function startRandomDialogue() {
    // Show dialogue every 20-35 seconds randomly
    const randomDelay = 15000 + Math.random() * 15000;
    
    dialogueTimeout = setTimeout(() => {
        showDialogue();
        startRandomDialogue(); // Schedule next dialogue
    }, randomDelay);
}

function createScrollingMessage() {
    const carouselContainer = document.getElementById('carouselContainer');
    if (!carouselContainer) return;
    
    // Clear any existing messages
    carouselContainer.innerHTML = '';
    
    const messageElement = document.createElement('div');
    messageElement.className = 'carousel-text';
    
    if (isJeetMode) {
        messageElement.textContent = jeetMessage;
        messageElement.style.color = '#ff4444';
    } else {
        messageElement.textContent = carouselMessages[currentMessageIndex];
        messageElement.style.color = '#00ff40';
        currentMessageIndex = (currentMessageIndex + 1) % carouselMessages.length;
    }
    
    carouselContainer.appendChild(messageElement);
}

function createArrowShoot() {
    const arrowCount = 25;
    
    for (let i = 0; i < arrowCount; i++) {
        const arrow = document.createElement('img');
        arrow.src = 'arrow-up.png';
        arrow.className = 'arrow-up';
        arrow.style.left = Math.random() * window.innerWidth + 'px';
        arrow.style.animationDelay = Math.random() * 2 + 's';
        arrow.style.animationDuration = (2.5 + Math.random() * 1.5) + 's';
        
        const randomScale = 0.8 + Math.random() * 0.6;
        arrow.style.setProperty('--arrow-scale', randomScale);
        
        const randomRotation = (Math.random() - 0.5) * 15;
        arrow.style.setProperty('--arrow-rotation', randomRotation + 'deg');
        
        document.body.appendChild(arrow);
        
        setTimeout(() => {
            arrow.remove();
        }, 7000);
    }
}

function createConfetti(mcChange = 0) {
    const confettiCount = 35;
    const colors = ['#00ff40', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
    
    // Calculate inches based on market cap change
    const baseInches = Math.max(0.1, Math.min(10, mcChange / 1000)); // 1 inch per 1k change, capped between 0.1 and 10
    const inches = Math.round(baseInches * 10) / 10; // Round to 1 decimal place
    
    for (let i = 0; i < confettiCount; i++) {
        const isText = Math.random() < 0.3; // 30% chance of text
        
        if (isText) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti-text';
            confetti.textContent = `+${inches} INCH GYATT`;
            confetti.style.left = Math.random() * window.innerWidth + 'px';
            confetti.style.animationDelay = Math.random() * 3 + 's';
            confetti.style.animationDuration = (6 + Math.random() * 4) + 's';
            
            const randomScale = 0.8 + Math.random() * 0.8;
            confetti.style.setProperty('--random-scale', randomScale);
            
            const randomRotation = Math.random() * 360;
            confetti.style.setProperty('--random-rotation', randomRotation + 'deg');
            
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.color = randomColor;
            
            document.body.appendChild(confetti);
            
            setTimeout(() => {
                confetti.remove();
            }, 12000);
        } else {
            const confetti = document.createElement('img');
            confetti.src = 'logo.png';
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * window.innerWidth + 'px';
            confetti.style.animationDelay = Math.random() * 3 + 's';
            confetti.style.animationDuration = (6 + Math.random() * 4) + 's';
            
            const randomScale = 0.5 + Math.random() * 1.5;
            confetti.style.setProperty('--random-scale', randomScale);
            
            const randomRotation = Math.random() * 360;
            confetti.style.setProperty('--random-rotation', randomRotation + 'deg');
            
            // Remove random coloring - keep original logo colors
            
            document.body.appendChild(confetti);
            
            setTimeout(() => {
                confetti.remove();
            }, 12000);
        }
    }
}

function createNegativeConfetti(mcChange = 0) {
    const confettiCount = 20;
    
    // Calculate inches based on market cap change (absolute value for negative)
    const baseInches = Math.max(0.1, Math.min(10, Math.abs(mcChange) / 1000)); // 1 inch per 1k change, capped between 0.1 and 10
    const inches = Math.round(baseInches * 10) / 10; // Round to 1 decimal place
    
    for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti-text';
        confetti.textContent = `-${inches} INCH GYATT`;
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.animationDelay = Math.random() * 2 + 's';
        confetti.style.animationDuration = (6 + Math.random() * 4) + 's';
        
        const randomScale = 0.8 + Math.random() * 0.8;
        confetti.style.setProperty('--random-scale', randomScale);
        
        const randomRotation = Math.random() * 360;
        confetti.style.setProperty('--random-rotation', randomRotation + 'deg');
        
        confetti.style.color = '#ff4444';
        
        document.body.appendChild(confetti);
        
        setTimeout(() => {
            confetti.remove();
        }, 12000);
    }
}

function updateGrowthRate(mcChange, timeElapsed = 5000) {
    // Calculate growth rate per minute
    const changePerMinute = (mcChange / timeElapsed) * 60000;
    const percentChange = (changePerMinute / lastMc) * 100;
    
    growthRateHistory.push(percentChange);
    if (growthRateHistory.length > 6) { // Keep last 30 seconds of data
        growthRateHistory.shift();
    }
    
    // Average the recent growth rates
    currentGrowthRate = growthRateHistory.reduce((sum, rate) => sum + rate, 0) / growthRateHistory.length;
    
    // Update meter display
    const meterFill = document.getElementById('meterFill');
    const meterText = document.getElementById('meterText');
    
    const displayRate = Math.abs(currentGrowthRate);
    const meterPercent = Math.min(100, displayRate * 2); // Scale for visual
    
    meterFill.style.width = meterPercent + '%';
    meterText.textContent = (currentGrowthRate >= 0 ? '+' : '-') + displayRate.toFixed(1) + '%/min';
}

function playAppropriateSound(mcChange) {
    if (!audioEnabled) return;
    
    const absChange = Math.abs(mcChange);
    
    if (absChange >= 10000) {
        // Big pump/dump - play cheer
        cheerSound.currentTime = 0;
        cheerSound.volume = 0.3;
        cheerSound.play().catch(e => console.log('Cheer sound failed:', e));
    } else if (absChange >= 500 && mcChange > 0) {
        // Small gains - play coin sound
        coinSound.currentTime = 0;
        coinSound.volume = 0.2;
        coinSound.playbackRate = 0.9 + Math.random() * 0.2; // Vary pitch slightly
        coinSound.play().catch(e => console.log('Coin sound failed:', e));
    }
}

function checkMilestones(mc) {
    const milestones = [40000, 100000, 200000];
    
    milestones.forEach(milestone => {
        if (mc >= milestone && !milestonesFired.has(milestone)) {
            milestonesFired.add(milestone);
            triggerFireworks(milestone, mc);
        }
    });
}

function triggerFireworks(milestone, currentMc) {
    if (!audioEnabled) return;
    
    // Play fireworks sound
    fireworksSound.currentTime = 0;
    fireworksSound.volume = 0.4;
    fireworksSound.play().catch(e => console.log('Fireworks sound failed:', e));
    
    // Create visual fireworks effect
    createFireworksEffect();
    
    // Show special message with current market cap
    const specialMessages = {
        40000: `🎆 FORTY THOUSAND GYATT! 🎆\nCurrent: $${currentMc.toLocaleString()}`,
        100000: `🎆 SIX FIGURES BABY! 🎆\nCurrent: $${currentMc.toLocaleString()}`,
        200000: `🎆 LEGENDARY MILESTONE! 🎆\nCurrent: $${currentMc.toLocaleString()}`
    };
    
    setTimeout(() => {
        showAchievement("🎆 Milestone Reached! 🎆", specialMessages[milestone] || `🎆 FIREWORKS! 🎆\nCurrent: $${currentMc.toLocaleString()}`);
    }, 500);
}

function createFireworksEffect() {
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#ffd700', '#ff9ff3', '#54a0ff'];
    
    for (let i = 0; i < 50; i++) {
        setTimeout(() => {
            const firework = document.createElement('div');
            firework.style.cssText = `
                position: fixed;
                width: 4px;
                height: 4px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                border-radius: 50%;
                pointer-events: none;
                z-index: 15000;
                left: ${20 + Math.random() * (window.innerWidth - 40)}px;
                top: ${20 + Math.random() * (window.innerHeight - 40)}px;
                animation: fireworkExplode 2s ease-out forwards;
            `;
            
            document.body.appendChild(firework);
            setTimeout(() => firework.remove(), 2000);
        }, Math.random() * 1000);
    }
}

function checkAchievements(mc, mcChange) {
    // Track consecutive increases for streak achievement
    if (mcChange > 0) {
        consecutiveIncreases++;
    } else if (mcChange < 0) {
        consecutiveIncreases = 0; // Reset on any decrease
    }
    
    Object.keys(achievements).forEach(key => {
        const achievement = achievements[key];
        if (achievement.unlocked) return;
        
        let shouldUnlock = false;
        let customDesc = null;
        
        // Special achievement logic with dynamic descriptions
        if (key === 'firstPump' && mcChange > 0) {
            shouldUnlock = true;
            customDesc = `Market cap increased by $${Math.abs(mcChange).toLocaleString()}! Your first pump!`;
        } else if (key === 'whale' && Math.abs(mcChange) >= 10000 && !isFirstLoad) {
            shouldUnlock = true;
            const changeType = mcChange > 0 ? 'increased' : 'decreased';
            customDesc = `Market cap ${changeType} by $${Math.abs(mcChange).toLocaleString()} in one move! Whale activity detected!`;
        } else if (key === 'streak3' && consecutiveIncreases >= 3) {
            shouldUnlock = true;
            customDesc = `${consecutiveIncreases} consecutive market cap increases! You're on fire!`;
        } else if (key === 'streak5' && consecutiveIncreases >= 5) {
            shouldUnlock = true;
            customDesc = `${consecutiveIncreases} consecutive market cap increases! Unstoppable momentum!`;
        } else if (key === 'streak10' && consecutiveIncreases >= 10) {
            shouldUnlock = true;
            customDesc = `${consecutiveIncreases} consecutive market cap increases! This is legendary!`;
        } else if (achievement.threshold > 0 && mc >= achievement.threshold) {
            shouldUnlock = true;
            customDesc = `Market cap reached $${mc.toLocaleString()}! Milestone achieved!`;
        }
        
        if (shouldUnlock) {
            unlockAchievement(key, customDesc);
        }
    });
}

function unlockAchievement(key, customDesc = null) {
    const achievement = achievements[key];
    achievement.unlocked = true;
    achievementCount++;
    
    updateAchievementCounter();
    // Use custom description if provided, otherwise use default
    const description = customDesc || achievement.desc;
    showAchievement(achievement.title, description);
}

let achievementQueue = [];
let isShowingAchievement = false;
let bossSystem;

// Global timer references for cleanup
let marketCapInterval = null;
let scrollingMessageInterval = null;
let normalFetchInterval = 5000; // Normal 5 second interval
let battleFetchInterval = 2000; // Fast 2 second interval during battles

// Function to change market cap fetch frequency
function setMarketCapFetchInterval(intervalMs) {
    if (marketCapInterval) {
        clearInterval(marketCapInterval);
    }
    marketCapInterval = setInterval(fetchMarketCap, intervalMs);
    console.log(`Market cap fetch interval set to ${intervalMs}ms`);
}

function showAchievement(title, description) {
    // Queue achievements during boss battles instead of ignoring them
    if (window.bossSystemPaused) {
        achievementQueue.push({ title, description });
        return;
    }
    
    // Add to queue if already showing an achievement
    if (isShowingAchievement) {
        achievementQueue.push({ title, description });
        return;
    }
    
    displayAchievement(title, description);
}

function displayAchievement(title, description) {
    const popup = document.getElementById('achievementPopup');
    const titleEl = document.getElementById('achievementTitle');
    const descEl = document.getElementById('achievementDesc');
    
    isShowingAchievement = true;
    
    titleEl.textContent = title;
    descEl.textContent = description;
    
    popup.classList.add('show');
    
    setTimeout(() => {
        popup.classList.remove('show');
        isShowingAchievement = false;
        
        // Show next achievement in queue if any
        if (achievementQueue.length > 0) {
            const next = achievementQueue.shift();
            setTimeout(() => {
                displayAchievement(next.title, next.description);
            }, 300); // Small delay between achievements
        }
    }, 3000);
}

function updateAchievementCounter() {
    const counterText = document.getElementById('counterText');
    const totalAchievements = Object.keys(achievements).length;
    counterText.textContent = `${achievementCount}/${totalAchievements}`;
}

function buildRuler(centerMc) {
    Array.from(ruler.children).forEach(c => { if(c !== rulerPointer) c.remove(); });

    const containerHeight = ruler.clientHeight;
    const visibleRange = 25000;
    const majorTickStep = 10000;
    const minorTickStep = 5000;
    const pxPerUnit = containerHeight / (2 * visibleRange);

    const startMc = 0;
    const endMc = Math.ceil((centerMc + visibleRange)/minorTickStep) * minorTickStep;
    
    // Calculate the actual position of the top corner of top.png
    const topImageRect = topImage.getBoundingClientRect();
    const containerRect = document.body.getBoundingClientRect();
    const topCornerY = topImageRect.top - containerRect.top;
    
    const pointerY = topCornerY;

    for (let mc = startMc; mc <= endMc; mc += minorTickStep) {
        const y = pointerY - (mc - centerMc) * pxPerUnit;

        const tick = document.createElement("div");
        tick.className = "tick";
        tick.style.top = y + "px";
        tick.style.opacity = (mc % majorTickStep === 0) ? "1" : "0.15";
        ruler.appendChild(tick);

        if (mc % majorTickStep === 0 && mc >= 0) {
            const label = document.createElement("div");
            label.className = "tick-label";
            label.textContent = "$" + mc.toLocaleString();
            label.style.top = y + "px";
            ruler.appendChild(label);
        }
    }

    rulerPointer.style.top = pointerY + "px";
}

function updateRuler(marketCap) {
    const steps = 10;
    let step = 0;
    const startMc = lastMc;
    const delta = (marketCap - startMc) / steps;

    const anim = setInterval(() => {
        step++;
        const mc = startMc + delta * step;
        buildRuler(mc);
        if(step >= steps) {
            clearInterval(anim);
            lastMc = marketCap;
        }
    }, 30);
}

function updateScale(newScale) {
    newScale = parseFloat(newScale);
    if (newScale === scaleFactor) return;

    const currentScale = scaleFactor;
    scaleFactor = newScale;

    bottomImage.classList.remove("bounce-animation");
    void bottomImage.offsetWidth;
    bottomImage.classList.add("bounce-animation");

    if (scaleFactor >= 1.8) {
        let panRate = 20;
        if (scaleFactor >= 2.4) panRate = 40;
        const newBackgroundPosition = Math.max(0, 100 - (scaleFactor - 1.8) * panRate);
        
        // Add motion blur if background position is changing
        if (Math.abs(newBackgroundPosition - backgroundPosition) > 0.1) {
            document.body.style.filter = 'blur(8px)';
            
            // Remove blur after transition completes
            setTimeout(() => {
                document.body.style.filter = 'blur(0px)';
            }, 200);
        }
        
        backgroundPosition = newBackgroundPosition;
        document.body.style.backgroundPosition = `center ${backgroundPosition}%`;
    } else {
        // Reset background position when scale drops below panning threshold
        if (backgroundPosition !== 100) {
            backgroundPosition = 100;
            document.body.style.backgroundPosition = `center ${backgroundPosition}%`;
        }
    }

    bottomImage.style.setProperty('--current-scale', currentScale);
    bottomImage.style.setProperty('--new-scale', scaleFactor);
    imageStack.style.transform = `translateX(-50%)`;

    let effectiveScale = scaleFactor;
    if (scaleFactor > 6) {
        const extraScale = scaleFactor - 6;
        effectiveScale = 6 + (extraScale * 0.3);
    }

    const heightIncrease = bottomImage.naturalHeight * (effectiveScale - 1);
    const baseMultiplier = scaleFactor >= 2.0 ? 0.63 : 0.68;
    const spacingAdjustment = Math.max(0, heightIncrease * baseMultiplier);

    topImage.style.transform = `translate(44px, ${45 - spacingAdjustment}px)`;
    bottomImage.style.transform = `scale(${effectiveScale})`;
}


async function fetchMarketCap() {
    try {
        const res = await fetch("/api/marketcap");
        const data = await res.json();
        const price = Number(data.usdPrice || 0);
        const mc = price * supply;

        // Animate market cap change if there's a previous value
        if (lastMc && lastMc !== mc) {
            marketCapDisplay.innerHTML = "Market Cap: <span class='marketcap-amount'>$" + lastMc.toLocaleString() + "</span>";
            animateMarketCapChange(lastMc, mc);
        } else {
            marketCapDisplay.innerHTML = "Market Cap: <span class='marketcap-amount'>$" + mc.toLocaleString() + "</span>";
        }

       // Dynamic scaling with fast growth to 90k, then slower
        let newScale;
        const fastGrowthLimit = 90000; // 90k market cap
        
        if (mc <= fastGrowthLimit) {
            // Fast scaling from 1x to ~2.8x for market cap up to 90k
            const frac = Math.max(0, Math.min(1, (mc - minMc) / (fastGrowthLimit - minMc)));
            // Using square root for fast initial growth
            newScale = 1 + 1.8 * Math.sqrt(frac);
        } else if (mc <= maxMc) {
            // Slower scaling from ~2.8x to 3.5x for market cap from 90k to 200k
            const frac = (mc - fastGrowthLimit) / (maxMc - fastGrowthLimit);
            // Using more gradual curve for higher market caps
            newScale = 2.8 + 0.7 * Math.pow(frac, 1.5);
        } else {
            // Continue slower scaling beyond 200k market cap
            const excessMc = mc - maxMc;
            const excessFrac = excessMc / (maxMc - minMc);
            // Very gradual scaling beyond 200k
            const excessScale = 0.5 * Math.pow(excessFrac, 2.0);
            newScale = 3.5 + excessScale;
        }
        updateScale(newScale);
        updateRuler(mc);

        if (lastMc && audioEnabled) {
            const mcChange = mc - lastMc;
            
            if (mc > lastMc) {
                audioUp.currentTime = 0;
                // Add random pitch variation (0.8x to 1.3x speed)
                audioUp.playbackRate = 0.8 + Math.random() * 0.5;
                audioUp.play().catch(e => console.log('Audio play failed:', e));
                createConfetti(mcChange);
                createArrowShoot();
                
                // New features
                updateGrowthRate(mcChange);
                playAppropriateSound(mcChange);
                checkMilestones(mc);
                checkAchievements(mc, mcChange);
                
                // Boss battle system
                if (bossSystem) {
                    bossSystem.updateBattle(mcChange);
                }
                
                if (isJeetMode) {
                    isJeetMode = false;
                    createScrollingMessage(); 
                }
            } else if (mc < lastMc) {
                audioDown.currentTime = 0;
                // Add random pitch variation (0.8x to 1.3x speed)
                audioDown.playbackRate = 0.8 + Math.random() * 0.5;
                audioDown.play().catch(e => console.log('Audio play failed:', e));
                createNegativeConfetti(mcChange);
                
                // New features
                updateGrowthRate(mcChange);
                playAppropriateSound(mcChange);
                checkAchievements(mc, mcChange);
                
                // Boss battle system
                if (bossSystem) {
                    bossSystem.updateBattle(mcChange);
                }
                
                if (!isJeetMode) {
                    isJeetMode = true;
                    createScrollingMessage(); 
                }
            }
        }
        lastMc = mc;
        
        // Set first load to false after first successful fetch
        if (isFirstLoad) {
            isFirstLoad = false;
        }
    } catch (err) {
        console.error("Error fetching market cap:", err);
        marketCapDisplay.innerHTML = "Market Cap: <span class='marketcap-amount'>Error</span>";
    }
}

let audioEnabled = false;

function playNextTrack() {
    if (currentBgMusic) {
        currentBgMusic.pause();
        currentBgMusic.currentTime = 0;
    }
    
    currentTrackIndex = (currentTrackIndex + 1) % bgMusicTracks.length;
    currentBgMusic = bgMusicTracks[currentTrackIndex];
    
    if (audioEnabled) {
        currentBgMusic.volume = 0.01;
        currentBgMusic.play().catch(e => console.log('Background music failed:', e));
        updateNowPlaying();
    }
}

function updateNowPlaying() {
    const trackControls = document.getElementById('trackControls');
    const trackName = document.getElementById('trackName');
    
    if (audioEnabled) {
        trackControls.style.display = 'flex';
        trackName.textContent = `Track ${currentTrackIndex + 1}`;
    } else {
        trackControls.style.display = 'none';
    }
}

function skipToPrevious() {
    if (currentBgMusic) {
        currentBgMusic.pause();
        currentBgMusic.currentTime = 0;
    }
    
    currentTrackIndex = (currentTrackIndex - 1 + bgMusicTracks.length) % bgMusicTracks.length;
    currentBgMusic = bgMusicTracks[currentTrackIndex];
    
    if (audioEnabled) {
        currentBgMusic.volume = 0.01;
        currentBgMusic.play().catch(e => console.log('Background music failed:', e));
        updateNowPlaying();
    }
}

function skipToNext() {
    playNextTrack();
}

function animateMarketCapChange(fromValue, toValue, duration = 1000) {
    const marketCapAmount = document.querySelector('.marketcap-amount');
    marketCapAmount.classList.add('animating');
    
    // Add decreasing class for red glow if value is going down
    if (toValue < fromValue) {
        marketCapAmount.classList.add('decreasing');
    }
    
    const startTime = Date.now();
    const difference = toValue - fromValue;
    
    function updateValue() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easeProgress = progress < 0.5 
            ? 2 * progress * progress 
            : 1 - Math.pow(-2 * progress + 2, 3) / 2;
        
        const currentValue = fromValue + (difference * easeProgress);
        marketCapAmount.textContent = '$' + Math.round(currentValue).toLocaleString();
        
        if (progress < 1) {
            requestAnimationFrame(updateValue);
        } else {
            marketCapAmount.classList.remove('animating', 'decreasing');
        }
    }
    
    updateValue();
}

function setupMusicEvents() {
    bgMusicTracks.forEach((track, index) => {
        track.addEventListener('ended', () => {
            if (audioEnabled) {
                playNextTrack();
            }
        });
    });
}

function enableAudio() {
    audioEnabled = true;
    updateSoundButton();
    updateNowPlaying();
    
    // Set background music volume and start playing
    currentBgMusic.volume = 0.01;
    currentBgMusic.play().catch(e => console.log('Background music failed:', e));
    
    audioUp.play().then(() => {
        audioUp.pause();
        audioUp.currentTime = 0;
    }).catch(e => console.log('Audio test failed:', e));
    audioDown.play().then(() => {
        audioDown.pause();
        audioDown.currentTime = 0;
    }).catch(e => console.log('Audio test failed:', e));
}

function toggleSound() {
    audioEnabled = !audioEnabled;
    updateSoundButton();
    updateNowPlaying();
    
    if (audioEnabled) {
        // Start background music
        currentBgMusic.volume = 0.01;
        currentBgMusic.play().catch(e => console.log('Background music failed:', e));
        
        audioUp.play().then(() => {
            audioUp.pause();
            audioUp.currentTime = 0;
        }).catch(e => console.log('Audio test failed:', e));
    } else {
        // Stop background music
        currentBgMusic.pause();
    }
}

function updateSoundButton() {
    const soundButton = document.getElementById('soundToggle');
    if (audioEnabled) {
        soundButton.textContent = '🔊 Special effects ON';
        soundButton.classList.remove('disabled');
    } else {
        soundButton.textContent = '🔇 Special effects OFF';
        soundButton.classList.add('disabled');
    }
}

window.addEventListener('load', function() {
    // Initialize global state
    window.bossSystemPaused = false;
    window.achievementQueue = achievementQueue;
    window.isShowingAchievement = isShowingAchievement;
    window.displayAchievement = displayAchievement;
    window.setMarketCapFetchInterval = setMarketCapFetchInterval;
    window.normalFetchInterval = normalFetchInterval;
    window.battleFetchInterval = battleFetchInterval;
    
    updateAchievementCounter();
    buildRuler(minMc);
    
    // Initialize boss system
    if (typeof BossSystem !== 'undefined') {
        bossSystem = new BossSystem();
    }
    
    fetchMarketCap();
    setMarketCapFetchInterval(normalFetchInterval);
    
    createScrollingMessage();
    scrollingMessageInterval = setInterval(createScrollingMessage, 10000); 
    
    // Start random dialogue system
    startRandomDialogue();
    
    // Setup music system
    setupMusicEvents();
    
    document.getElementById('soundToggle').addEventListener('click', toggleSound);
    document.getElementById('prevTrack').addEventListener('click', skipToPrevious);
    document.getElementById('nextTrack').addEventListener('click', skipToNext);
    
    document.addEventListener('click', enableAudio, { once: true });
    document.addEventListener('keydown', enableAudio, { once: true });
});

// Cleanup function for proper state management
function cleanup() {
    // Clear all intervals
    if (marketCapInterval) {
        clearInterval(marketCapInterval);
        marketCapInterval = null;
    }
    if (scrollingMessageInterval) {
        clearInterval(scrollingMessageInterval);
        scrollingMessageInterval = null;
    }
    
    // Clear timeouts
    if (dialogueTimeout) {
        clearTimeout(dialogueTimeout);
        dialogueTimeout = null;
    }
    if (typeTextTimeout) {
        clearTimeout(typeTextTimeout);
        typeTextTimeout = null;
    }
    if (window.dialogueHideTimeout) {
        clearTimeout(window.dialogueHideTimeout);
        window.dialogueHideTimeout = null;
    }
    
    // Clean up boss system
    if (bossSystem && typeof bossSystem.destroy === 'function') {
        bossSystem.destroy();
    }
    
    // Reset global state
    window.bossSystemPaused = false;
    isShowingAchievement = false;
    achievementQueue.length = 0;
}

// Cleanup on page unload
window.addEventListener('beforeunload', cleanup);
</script>

</body>
</html>